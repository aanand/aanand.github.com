<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>The Abstracted Negroni - Aanand Prasad</title>
    <meta content="Aanand Prasad" name="author" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link href="/articles.xml" rel="alternate" type="application/atom+xml" />
    <link href="/stylesheets/main.css" rel="stylesheet" type="text/css" />
    <!--[if lt IE 9]><link href="/stylesheets/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
    <script type="text/javascript">var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-4209567-1']);
      _gaq.push(['_setSiteSpeedSampleRate', 100]);
      _gaq.push(['_trackPageview']); 
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();</script>
  </head>
  <body>
    <div class="container"><div class="content"><header>
    <h1 class="logo">
      <a href="/"><span>Aanand Prasad</span></a>
    </h1>
    <ul class="links">
      <li>
        <a href="http://twitter.com/aanand">Twitter</a>
      </li>
      <li>
        <a href="http://github.com/aanand">Github</a>
      </li>
      <li>
        <a href="mailto:aanand.prasad@gmail.com">Email</a>
      </li>
    </ul>
  </header><article class="article">
    <h2 class="title">The Abstracted Negroni</h2><p>I was out last Friday at a bar where they had a &#8220;Negroni Tic-Tac-Toe&#8217; offer&#8212;you could custom-build your drink from a selection of 3 gins, 3 vermouths and 3 amari, and if you got &#8220;3 in a row&#8221; you&#8217;d get &#163;5 off your bill. It&#8217;s a laughably stingy deal, but it got me thinking.</p>

<pre><code><span class="k">class</span> <span class="nx">Negroni</span>
  <span class="nv">constructor: </span><span class="nf">(@gin, @vermouth, @amaro) -&gt;</span>
    <span class="c1"># Build over ice, stir well</span>

  <span class="nv">toString: </span><span class="nf">-&gt;</span> <span class="s">"Negroni(</span><span class="si">#{</span><span class="nx">@gin</span><span class="si">}</span><span class="s">, </span><span class="si">#{</span><span class="nx">@vermouth</span><span class="si">}</span><span class="s">, </span><span class="si">#{</span><span class="nx">@amaro</span><span class="si">}</span><span class="s">)"</span>

  <span class="c1"># for the Node console</span>
  <span class="nv">inspect: </span><span class="nf">-&gt;</span> <span class="nx">@toString</span><span class="p">()</span></code></pre>

<p>The Negroni is often described as a &#8220;manly&#8221; drink, but fuck your gender-essentialism&#8212;let&#8217;s just call it <em>badass</em>. Everything I ever needed to know about it, by the way, I learned from <a href="http://manhattansproject.com/on-the-negroni/">Felix</a>. I personally find Punt e Mes a shade too bitter when combined with Campari, but that&#8217;s just me.</p>

<pre><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"Here's how I make it at home:"</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="k">new</span> <span class="nx">Negroni</span><span class="p">(</span><span class="s">"Botanist"</span><span class="p">,</span> <span class="s">"Martini Rosso"</span><span class="p">,</span> <span class="s">"Campari"</span><span class="p">)</span></code></pre>

<p>Point is, there are 3&#215;3&#215;3&#160;=&#160;27 possible combinations at that bar, a delicious Rubik&#8217;s Cube of liver damage. How would you enumerate them all?</p>

<pre><code><span class="nv">assemble = </span><span class="nf">(g, v, a) -&gt;</span>
  <span class="nx">g</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(gin) -&gt;</span>
    <span class="nx">v</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(vermouth) -&gt;</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(amaro) -&gt;</span>
        <span class="k">new</span> <span class="nx">Negroni</span><span class="p">(</span><span class="nx">gin</span><span class="p">,</span> <span class="nx">vermouth</span><span class="p">,</span> <span class="nx">amaro</span><span class="p">)</span>

<span class="nv">allGins      = </span><span class="p">[</span><span class="s">"Botanist"</span><span class="p">,</span> <span class="s">"Bombay Sapphire"</span><span class="p">,</span> <span class="s">"Blackwoods 60%"</span><span class="p">]</span>
<span class="nv">allVermouths = </span><span class="p">[</span><span class="s">"Martini Rosso"</span><span class="p">,</span> <span class="s">"Cocchi"</span><span class="p">,</span> <span class="s">"Punt e Mes"</span><span class="p">]</span>
<span class="nv">allAmari     = </span><span class="p">[</span><span class="s">"Campari"</span><span class="p">,</span> <span class="s">"Aperol"</span><span class="p">,</span> <span class="s">"Cynar"</span><span class="p">]</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">assemble</span><span class="p">(</span><span class="nx">allGins</span><span class="p">,</span> <span class="nx">allVermouths</span><span class="p">,</span> <span class="nx">allAmari</span><span class="p">)</span>

<span class="c1"># =&gt; [ [ [ Negroni(Botanist, Martini Rosso, Campari),</span>
<span class="c1">#          Negroni(Botanist, Martini Rosso, Aperol),</span>
<span class="c1">#          Negroni(Botanist, Martini Rosso, Cynar) ],</span>
<span class="c1">#        [ Negroni(Botanist, Cocchi, Campari),</span>
<span class="c1">#          Negroni(Botanist, Cocchi, Aperol),</span>
<span class="c1">#          Negroni(Botanist, Cocchi, Cynar) ],</span>
<span class="c1">#      ...]</span>
<span class="c1">#    ...]</span></code></pre>

<p>Hmmm. It&#8217;s a start, but that&#8217;s altogether too much nesting. We&#8217;ll never get anything done if we&#8217;re spending all our time unboxing drinks.</p>

<pre><code><span class="nb">Array</span><span class="p">.</span><span class="nv">prototype.flatMap = </span><span class="nf">(fn) -&gt;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">fn</span><span class="p">).</span><span class="nx">reduce</span><span class="p">((</span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">b</span><span class="p">)),</span> <span class="p">[])</span>

<span class="nv">assemble = </span><span class="nf">(g, v, a) -&gt;</span>
  <span class="nx">g</span><span class="p">.</span><span class="nx">flatMap</span> <span class="nf">(gin) -&gt;</span>
    <span class="nx">v</span><span class="p">.</span><span class="nx">flatMap</span> <span class="nf">(vermouth) -&gt;</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(amaro) -&gt;</span>
        <span class="k">new</span> <span class="nx">Negroni</span><span class="p">(</span><span class="nx">gin</span><span class="p">,</span> <span class="nx">vermouth</span><span class="p">,</span> <span class="nx">amaro</span><span class="p">)</span></code></pre>

<p>The outer two <code>map</code>s are replaced with <code>flatMap</code>, which maps and then flattens the resulting array.</p>

<pre><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">assemble</span><span class="p">(</span><span class="nx">allGins</span><span class="p">,</span> <span class="nx">allVermouths</span><span class="p">,</span> <span class="nx">allAmari</span><span class="p">)</span>

<span class="c1"># =&gt; [ Negroni(Botanist, Martini Rosso, Campari),</span>
<span class="c1">#      Negroni(Botanist, Martini Rosso, Aperol),</span>
<span class="c1">#      Negroni(Botanist, Martini Rosso, Cynar),</span>
<span class="c1">#      Negroni(Botanist, Cocchi, Campari),</span>
<span class="c1">#      Negroni(Botanist, Cocchi, Aperol),</span>
<span class="c1">#      Negroni(Botanist, Cocchi, Cynar),</span>
<span class="c1">#      Negroni(Botanist, Punt e Mes, Campari),</span>
<span class="c1">#    ...]</span></code></pre>

<p>Much better.</p>

<p>Of course, it&#8217;s almost never a good idea to make 27 cocktails. Let&#8217;s row back a bit and consider a much more common scenario: you&#8217;ve got a guest round and they&#8217;d fancy just one. They don&#8217;t much mind <em>what</em> gin, vermouth or amaro it&#8217;s made with&#8212;you&#8217;re more worried about whether you have them at all. Can you satisfy them?</p>

<p>We need to represent the <em>potential presence or absence</em> of a thing.</p>

<pre><code><span class="nv">yep = </span><span class="nf">(thing) -&gt;</span>
  <span class="p">{</span>
    <span class="nv">toString: </span><span class="nf">-&gt;</span> <span class="s">"yep(</span><span class="si">#{</span><span class="nx">thing</span><span class="si">}</span><span class="s">)"</span>
    <span class="nv">inspect: </span> <span class="nf">-&gt;</span> <span class="nx">@toString</span><span class="p">()</span>
  <span class="p">}</span>

<span class="nv">nope =</span>
  <span class="p">{</span>
    <span class="nv">toString: </span><span class="nf">-&gt;</span> <span class="s">"nope"</span>
    <span class="nv">inspect: </span> <span class="nf">-&gt;</span> <span class="nx">@toString</span><span class="p">()</span>
  <span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">yep</span><span class="p">(</span><span class="s">"Gin"</span><span class="p">)</span> <span class="c1"># =&gt; yep(Gin)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">nope</span>       <span class="c1"># =&gt; nope</span></code></pre>

<p>So, time to write a new <code>assemble()</code> method, right? To check individually for the presence or absence of each of our ingredients, and only return a <code>yep()</code> if we&#8217;ve got all 3?</p>

<p>Nope. <code>assemble()</code> can stay as it is. We just need to implement <code>map</code> and <code>flatMap</code>.</p>

<pre><code><span class="nv">yep = </span><span class="nf">(thing) -&gt;</span>
  <span class="p">{</span>
    <span class="nv">toString: </span><span class="nf">-&gt;</span> <span class="s">"yep(</span><span class="si">#{</span><span class="nx">thing</span><span class="si">}</span><span class="s">)"</span>
    <span class="nv">inspect: </span> <span class="nf">-&gt;</span> <span class="nx">@toString</span><span class="p">()</span>

    <span class="nv">map: </span>    <span class="nf">(f) -&gt;</span> <span class="nx">yep</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">thing</span><span class="p">))</span>
    <span class="nv">flatMap: </span><span class="nf">(f) -&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">thing</span><span class="p">)</span>
  <span class="p">}</span>

<span class="nv">nope =</span>
  <span class="p">{</span>
    <span class="nv">toString: </span><span class="nf">-&gt;</span> <span class="s">"nope"</span>
    <span class="nv">inspect: </span> <span class="nf">-&gt;</span> <span class="nx">@toString</span><span class="p">()</span>

    <span class="nv">map: </span>    <span class="nf">(f) -&gt;</span> <span class="nx">nope</span>
    <span class="nv">flatMap: </span><span class="nf">(f) -&gt;</span> <span class="nx">nope</span>
  <span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"If we have no ingredients:"</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">assemble</span><span class="p">(</span><span class="nx">nope</span><span class="p">,</span> <span class="nx">nope</span><span class="p">,</span> <span class="nx">nope</span><span class="p">)</span>
<span class="c1"># =&gt; nope</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"If we have only gin and vermouth:"</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">assemble</span><span class="p">(</span><span class="nx">yep</span><span class="p">(</span><span class="s">"Gin"</span><span class="p">),</span> <span class="nx">yep</span><span class="p">(</span><span class="s">"Vermouth"</span><span class="p">),</span> <span class="nx">nope</span><span class="p">)</span>
<span class="c1"># =&gt; nope</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"If we have gin and vermouth and amaro:"</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">assemble</span><span class="p">(</span><span class="nx">yep</span><span class="p">(</span><span class="s">"Gin"</span><span class="p">),</span> <span class="nx">yep</span><span class="p">(</span><span class="s">"Vermouth"</span><span class="p">),</span> <span class="nx">yep</span><span class="p">(</span><span class="s">"Amaro"</span><span class="p">))</span>
<span class="c1"># =&gt; yep(Negroni(Gin, Vermouth, Amaro))</span></code></pre>

<p>Magic. <code>assemble()</code> will accept anything that supports those two methods. All it expresses is that you need all 3 ingredients to make a Negroni&#8212;not how to get them, or how many to make.</p>

<p>Sadly, it turns out we don&#8217;t have any of the ingredients to hand. You can go online and order them, though, and indeed have 3 fast-delivery specialist suppliers (one per ingredient&#8212;they&#8217;re <em>highly</em> specialised) bookmarked for this very purpose. Within a few moments, each one has promised that a bottle is on its way to you, and you can thus pass on the promise of a Negroni to your patient, thirsty guest.</p>

<pre><code><span class="nv">Promise = </span><span class="nx">require</span><span class="p">(</span><span class="s">"promise"</span><span class="p">)</span>

<span class="nv">Promise.prototype.map     = </span><span class="nf">(fn) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
<span class="nv">Promise.prototype.flatMap = </span><span class="nf">(fn) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>

<span class="nv">order = </span><span class="nf">(name) -&gt;</span>
  <span class="k">new</span> <span class="nx">Promise</span> <span class="nf">(resolve) -&gt;</span>
    <span class="nx">setTimeout</span><span class="p">((</span><span class="nf">-&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">name</span><span class="p">)),</span> <span class="mi">1000</span><span class="p">)</span>

<span class="nv">g = </span><span class="nx">order</span><span class="p">(</span><span class="s">"Gin"</span><span class="p">)</span>      <span class="c1"># a promise of gin</span>
<span class="nv">v = </span><span class="nx">order</span><span class="p">(</span><span class="s">"Vermouth"</span><span class="p">)</span> <span class="c1"># a promise of vermouth</span>
<span class="nv">a = </span><span class="nx">order</span><span class="p">(</span><span class="s">"Amaro"</span><span class="p">)</span>    <span class="c1"># a promise of amaro</span>

<span class="nv">promisedNegroni = </span><span class="nx">assemble</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="c1"># a promise of a Negroni</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"Your Negroni is on its way. Here's your order:"</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">promisedNegroni</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"Any second now..."</span>

<span class="nx">promisedNegroni</span><span class="p">.</span><span class="nx">then</span> <span class="nf">(negroni) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"Ah! It's here: </span><span class="si">#{</span><span class="nx">negroni</span><span class="si">}</span><span class="s">"</span></code></pre><hr />
    <div class="metadata">
      <div class="created"><time datetime='2013-04-15'>15 April 2013</time></div>
      <a class="permalink" href="&#47;articles&#47;negronis&#47;">Permalink</a>
    </div>
  </article>
</div></div>
  </body>
</html>